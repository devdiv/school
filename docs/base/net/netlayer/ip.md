# IP协议

Internet Protocol 简称IP，又译为网际协议或互联网协议，是用在TCP/IP 协议簇中的网络层协议。RFC 791“INTERNET PROTOCOL（Internet协议）”是IP协议的正式规范文件。随着Internet技术的发展，还有一些RFC文档对IP协议进行补充和扩展。

IP协议位于TCP/IP协议的网络层，位于同一层次的协议还有下面的ARP和RARP以及上面的ICMP（Internet控制报文协议）和IGMP（Internet组管理协议）。除了ARP和RARP报文以外的几乎所有的数据都要经过IP协议进行传送。ARP和RARP报文没有封装在IP数据报中，而ICMP和IGMP的数据则要封装在IP数据报中进行传输。由于IP协议在网络层中具有重要的地位，TCP/IP协议的网络层又被称为IP层。

![image](./assets/ip-5.png)

IP 协议是为了在分组交换（Packet-switched，又译为包交换）计算机通信网络的互联系统中使用而设计的。IP层只负责数据的路由和传输，在源节点与目的节点之间传送数据报，但并不处理数据内容。数据报中有目的地址等必要内容，使每个数据报经过不同的路径也能准确地到达目的地，在目的地重新组合还原成原来发送的数据。

::: tip 提示
分组（Packet，又译为包或数据包）是在网络上传送的任一数据单位，容量可大可小，除了数据以外，分组还带有发送方和接收方的地址以及差错控制信息。IP协议将所传输的分组称为数据报（Datagram）。数据报指一个完整的 IP 信息，往往专指使用无连接网络服务的数据单元。在IP层，数据报等同于分组或数据包，尤其在提到路由时，往往称数据包。
:::

**IP协议使用以下4个主要的机制来提供服务**。

- 服务类型（Type of Service）：用来指示要求的服务质量。
- 生存时间（Time to Live）：数据报生存时间的上限。
- 选项（Operation）：提供在某些情况下需要或有用的控制功能。
- 首部校验和（Header Checksum）：提供对IP首部内容进行出错检测的功能。

IP层向下要面对各种不同的物理网络，向上却要提供一个统一的数据传输服务。为此，IP层通过IP地址实现了物理地址的统一，通过IP数据报实现了数据帧的统一。IP层通过对以上两个方面的统一达到了向上屏蔽底层差异的目的。

IP协议提供了一种分层的、与硬件无关的寻址系统，它可以在复杂的路由式网络中传递数据所需的服务。IP协议可以将多个交换网络连接起来，在源地址和目的地址之间传送数据包。同时，它还提供数据重新组装功能，以适应不同网络对数据包大小的要求。

## IP协议的基本功能

IP的主要目的是通过一个互联的网络传输数据报，涉及两个最基本的功能。

- **寻址（Addressing）**：IP协议根据数据报首部中包括的目的地址将数据报传送到目的节点，这就要涉及传送路径的选择，即路由功能。IP协议使用IP地址来实现路由。
- **分片（Fragmentation）**：IP协议还提供对数据大小的分片和重组，以适应不同网络对数据包大小的限制。如果网络只能传送小数据包，IP协议将对数据报进行分段并重新组成小块再进行传送。

## IP协议的特性

IP 是一个无连接的、不可靠的、点对点的协议，只能尽力（Best Effort）传送数据，不能保证数据的到达。具体地讲，主要有以下特性。

- IP协议提供无连接数据报服务，各个数据报独立传输，可能沿着不同的路径到达目的地，也可能不会按序到达目的地。
- IP 协议不含错误检测或错误恢复的编码，属于不可靠的协议。所谓不可靠，是从数据传输的可靠性不能保证的角度而言的，查询的延误及其他网络通信故障都有可能导致所传数据的丢失。对这种情况，IP 协议本身不处理。它的不可靠并不能说明整个 TCP/IP 协议不可靠。如果要求数据传输具有可靠性，则要在IP的上面使用TCP协议加以保证。位于上一层的TCP协议则提供了错误检测和恢复机制。
- 作为一种点对点协议，虽然 IP 数据报携带源 IP 地址和目的 IP 地址，但进行数据传输时的对等实体一定是相邻设备（同一网络）中的对等实体。
- IP协议的效率非常高，实现起来也较简单。这是因为IP协议采用了尽力传输的思想，随着底层网络质量的日益提高，IP协议的尽力传输的优势体现得更加明显。

## IP协议的工作方式

在一个路由式网络中，源地址主机向目标地址主机发送数据时，IP协议是如何将数据成功发送到目标主机上的呢？由于网络分同网段和不同网段两种情况，工作方式如下：

### 同网段

如果源地址主机和目标地址主机在同一网段，目标IP地址被ARP协议解析为MAC地址，然后根据MAC地址，源主机直接把数据包发给目标主机。

### 不同网段

如果源地址主机和目标地址主机在不同网段，数据包发送过程如下：

（1）网关（一般为路由器）的IP地址被ARP协议解析为MAC地址。根据该MAC地址，源主机将数据包发送到网关。

（2）网关根据数据包中的网段ID寻找目标网络。如果找到，将数据包发送到目标网段；如果没找到，重复步骤（1）将数据包发送到上一级网关。

（3）数据包经过网关被发送到正确的网段中。目标IP地址被ARP协议解析为MAC地址。根据该MAC地址，数据包被发送给目标地址的主机。

## IP协议包结构

在TCP/IP协议中，使用IP协议传输数据的包被称为**IP数据包**。每个数据包都包含IP协议规定的内容。IP协议规定的这些内容被称为**IP数据报文（IP Datagram）或者IP数据报**。IP数据报文由首部和数据两部分组成。首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。

每个IP数据报都以一个IP报头开始。源计算机构造这个IP报头，而目的计算机利用IP报头中封装的信息处理数据。IP报头中包含大量的信息，如源IP地址、目的IP地址、数据报长度、IP版本号等。每个信息都被称为一个字段。IP数据报头字段如下图所示：

![image](./assets/ip-1.png)

- **版本（version）**：占4位，表示IP协议的版本。通信双方使用的IP协议版本必须一致。目前广泛使用的IP协议版本号为4，即IPv4。
- **首部长度（Internet Header Length，IHL）**：占4位，可表示的最大十进制数值是15。这个字段所表示数的单位是32位字长（1个32位字长是4字节）。因此，当IP的首部长度为1111时（即十进制的15），首部长度就达到60字节。当IP分组的首部长度不是4字节的整数倍时，必须利用最后的填充字段加以填充。数据部分永远在4字节的整数倍开始，这样在实现IP协议时较为方便。首部长度限制为60字节的缺点是，长度有时可能不够用，之所以限制长度为60字节，是希望用户尽量减少开销。最常用的首部长度就是20字节（即首部长度为0101），这时不使用任何选项。
- **差分服务（Differentiated Services，DS）**：也被称为服务类型，占8位，用来获得更好的服务。这个字段在旧标准中叫做服务类型，但实际上一直没有被使用过。1998年IETF把这个字段改名为区分服务（Differentiated Services，DS）。只有在使用区分服务时，这个字段才起作用。
::: tip 差分服务（Differentiated Services，DS）与服务类型（Type of Service，TOS）
详见 [*差分服务与服务类型*](#差分服务与服务类型)。
:::

- **总长度（Total Length）**：总长度占16位，指定包括首部和数据在内的IP数据报总长度，单位为字节。根据数据报总长度和首部长度可以计算出数据部分的长度。数据长度＝数据报总长度－首部长度×4。数据报总长度字段在将IP数据报封装到以太网帧中进行传输时是非常有用的。以太网要求帧中封装的数据最少46字节，当数据少于46字节时必须在数据的后面进行填充，使其达到46字节，通过IP数据报中的数据报总长度和首部长度可以计算出除去填充后的实际数据长度。。总长度字段为16位，因此数据报的最大长度为2^16-1=65535字节。
- **标识（Identification）**：用来标识数据报，占16位。IP协议在存储器中维持一个计数器。每产生一个数据报，计数器就加1，并将此值赋给标识字段。当数据报的长度超过网络的MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中。具有相同的标识字段值的分片报文会被重组成原来的数据报。
- **标志（Flags）**：标志占3位，用于表示该IP数据报是否允许分片以及是否是最后的一片。第1位保留，设置为0；第2位设置是否分片，0表示可以分片，1表示不分片；第3位表示是否最后一片，0表示已是最后一个分片，1 表示还有更多分片抵达。典型情况下允许分片，但是出于某些原因，应用程序可以决定不允许分片。
- **分片偏移（Fragmentation Offset）**：分片偏移占13位，描述该数据报分片在它所属的原始数据报数据区中的偏移量，为目的主机进行各分片的重组提供顺序依据。偏移量以8字节（64位）为一个单位。例如，第1个分片的偏移值可以是0，并包含了1400字节的数据（不包括任何首部），第2个分片的偏移值应该为175（1400/8=175）。
- **生存时间（Time to Live，TTL）**：表示数据报在网络中的寿命，占8位。该字段由发出数据报的源主机设置。其目的是防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。路由器在转发数据报之前，先把TTL值减1。若TTL值减少到0，则丢弃这个数据报，不再转发。因此，TTL指明数据报在网络中最多可经过多少个路由器。TTL的最大数值为255。若把TTL的初始值设为1，则表示这个数据报只能在本局域网中传送。
  
::: tip 说明
虽然RFC 791定义TTL以秒为单位，但是Internet的路由器无法进行准确的时间同步，因此路由器不能准确地计算出需要减去的时间。目前所采用的一种简单的处理办法是用经过路由器的个数（即跳数）进行控制，数据报每经过一个路由器，生存时间 TTL 值减 1。当 TTL 值减到 0时，如果仍未能到达目的地，便丢弃该数据报。典型的TTL起始值为32、64和128。
:::

- **协议（Protocol）**：表示该数据报文所携带的数据所使用的协议类型，占8位。该字段可以方便目的主机的IP层知道按照什么协议来处理数据部分。不同的协议有专门不同的协议号。例如，TCP的协议号为6，UDP的协议号为17，ICMP的协议号为1,IP的协议号则为0。
- **首部检验和（Header Checksum）**：用于校验数据报的首部，占16位。数据报每经过一个路由器，首部的字段都可能发生变化（如TTL），所以需要重新校验。而数据部分不发生变化，所以不用重新生成校验值。这是一种除了数据链路出错检测机制（如以太网的CRC）之外的出错检测机制。
- **源地址（Source Address）**：源地址占32位，指明源主机（最初发送者）的IP地址。在IP数据报从源主机发送到目的主机的时间内，这个字段必须保持不变。在某些情况下，如在DHCP引导过程中，IP主机或许并不知道自己的IP地址，因此这个字段可以使用0.0.0.0。这个字段不能包含多播或广播地址。
- **目的地址（Destination Address）**：目的地址占32位，指明目的主机（最终接收者）的IP地址。在IP数据报从源主机发送到目的主机的时间内，这个字段必须保持不变。这个字段能够包含单播、多播或广播地址。
  
::: tip 提示
在 IP 数据报的转发过程中，若干路由器会对物理帧进行解封装和再封装，物理地址会发生变化，但IP数据报的源地址和目的地址字段始终保持不变。
:::

- **可选字段（Options）**：该字段用于一些可选的报头设置，主要用于测试、调试和安全的目的。这些选项包括严格源路由（数据报必须经过指定的路由）、网际时间戳（经过每个路由器时的时间戳记录）和安全限制。
- **填充**：由于可选字段中的长度不是固定的，使用若干个0填充该字段，可以保证整个报头的长度是32位的整数倍。
- **数据部分**：表示传输层的数据，如保存TCP、UDP、ICMP或IGMP的数据。数据部分的长度不固定。

### 差分服务与服务类型

#### 服务类型（Type of Service，TOS）

服务类型占 8 位，提供所需服务质量的参数集，规定对本数据报的处理方式。包括优先级（Precedence）和服务类型两个部分。优先级在前3位中定义，服务类型在紧接着的后4位中定义，最后1位被保留并设置为0，如图所示：

![image](./assets/ip-6.png)

优先级表示本数据报的重要程度。当网络出现拥塞时，路由设备可以根据数据的优先级决定首先丢弃哪些数据报。RFC 791 中TOS 位的IP 优先级划分成了从0到7共8 个级别，可以应用于流分类，数值越大表示优先级越高，各级别说明见下表：

![image](./assets/ip-7.png)

在默认情况下，IP优先级6和7用于网络控制通信使用，不推荐用户使用。优先级的划分为有区别地对待不同数据提供了可能，但目前的IPv4并未使用优先级，统一用0表示。

服务类型表示本数据报在传输过程中所希望得到的服务，由用户设置。4 位服务类型分别用D（0为普通值，1为最小延迟）、T（0为普通值，1为最大吞吐率）、R（0为普通值，1为最高可靠性）和C（0为普通值，1为最低成本）表示，4位全为0时表示一般服务类型的数据报。表4-2列出了服务类型各位组合的设置类型。

![image](./assets/ip-8.png)

对于传输数据量比较大的协议一般要求高吞吐率，如FTP数据传输、SMTP数据传输、DNS区域传输；对于传输少量数据的协议一般要求低延迟，如 Telnet、FTP 控制信息、TFTP、SMTP命令；对于路由和网络管理信息，则要求较高的可靠性，如IGP和SNMP；对于直接向用户发送的一般新闻信息，则应该考虑采用较低成本的路径，如NNTP。ICMP、DNS（TCP）则属于一般服务。
不过，服务类型未能在现有的IP网络中普及使用。服务类型要求并不具有强制性，目前许多路由设备的TCP/IP实现中都不支持服务类型特性。新的路由协议（如OSPF）能够根据这些服务类型进行路由选择。在D、T、R和C这4个参数中每次只能设置其中的一个，也就是说，在传输时路由设备只能考虑一个性能指标，不可能照顾到每个性能指标。多个参数的同时指定只能使路由设备无所适从，所以没有实际意义。

#### 差分服务（Differentiated Services，DS）

RFC 791所定义的服务类型（TOS）字段现在已被新的差分服务（DS）字段所取代。随着Internet应用的迅速发展，多媒体数据传输和实时应用对TCP/IP的服务类型提出了更高的要求，为此 IETF 将 IP 数据报的服务类型字段改成了差分服务（Differentiated Services，DS）字段。

RFC 2474“Definition of the Differentiated Services Field（DS Field）in the IPv4 and IPv6 Headers（IPv4和IPv6首部中差分服务字段（DS字段）的定义）”、RFC 2475 “An Architecture for Differentiated Services（一种差分服务架构）”、RFC 3168 “TheAddition of Explicit Congestion Notification（ECN）to IP（显式拥塞通告（ECN）添加到 IP）”提供了原服务类型字段 8 位的新用途，将原来的优先级和服务类型替换为新的差分服务代码点（Differentiated Services Code Point，DSCP）和显式拥塞通告（ExplicitCongestion Notification，ECN），该字段被称为差分服务字段。

![image](./assets/ip-9.png)

##### 1.差分服务

RFC 791中定义8个优先级应用于流分类，但是在网络中实际部署的时候这8个优先级远远不够，于是在 RFC 2474 中又对服务类型字段进行重新定义，将该字段的前 6 位定义成 DSCP。DSCP给出流量的优先级，网络节点依据这个等级值排队和转发流量。

DSCP是IP优先级和服务类型字段的组合。为利用仅支持IP优先级的路由器，DSCP的定义向后与IP优先级兼容，DSCP可看做是IP优先级的超集。DSCP优先级值有64个（0～63），0优先级最低，63优先级最高。DSCP的可读性比较差，为此将DSCP进一步分成了以下4种类型。

（1）类选择器（Class Selector，CS）。

类选择器DSCP定义为向后与IP优先级兼容，值为8、16、24、32、40、48、56，后3位为0，格式为“aaa000”。也就是说类选择器仍然沿用了 IP 优先级，只不过它定义的 DSCP 为 IP 优先级的8 倍，如CS6 = 6×8 = 48，CS7 = 7×8 = 56。
CS6和CS7默认用于协议报文，如OSPF报文、BGP报文等应该优先保障，因为如果这些报文无法接收的话会引起协议中断。这是大多数厂商硬件队列里最高优先级的报文。

（2）加速转发（Expedited Forwarding，EF）。

加速转发DSCP一般用于低延迟的服务，推荐值为46（101110）。可以将它看做为IP优先级5，是一个比较高的优先级。
EF用于承载语音的流量，因为语音要求低延迟、低抖动、低丢包率，是仅次于协议报文的最重要的报文。

（3）确保转发（Assured Forwarding，AF）。

确保转发DSCP分为两部分，即a部分和b部分，格式为“aaabb0”。a部分为3位，仍然可以与IP优先级对应；b部分为2位，表示丢弃优先级。a部分最大取值为8，但是目前只用到了1～4。与十进制转换时，可以将DSCP十进制数值除以8得到的整数就是AF值，余数换算成二进制前两位就是丢弃优先级。例如，DSCP值34表示AF4，丢弃优先级为2（010），属于中等。确定转发定义了4个服务等级，每个服务等级有3个下降过程，具体的DSCP值为4组：（10，12，14），（18，20，22），（26，28，30），（34，36，38）。

AF4用来承载语音的信令（如呼叫控制）流量；AF3用来承载IPTV的直播流量，直播的实时性很强，需要连续性和大吞吐量的保证；AF2 用来承载 VOD 的流量，允许有延迟或者缓冲；AF1可承载不是很重要的专线业务。

（4）默认（Default，BE）。

默认的DSCP为000000。Internet业务最不重要，可以放在BE模型来传输。

##### 2.显式拥塞通告

为避免因为路由器拥塞而丢包所产生的一系列问题，设计了一种路由器向发送方报告发生拥塞的机制，让发送方在路由器开始丢包前降低发送速率，这种路由器报告和主机响应机制就是显式拥塞通告（简称ECN）。为了利用这项技术，拥塞链路的两端（发送方和接收方）必须支持ECN。在 IP 层一个发送主机必须能够表明自身支持 ECN，路由器在转发时必须能够表明它正在经历拥塞。根据RFC 3168，需要在IP数据报首部原服务类型字段中使用最后两个位来设置ECN字段，参见图4-4。一个是ECT（ECN-Capable Transport）位，由发送方设置以显示发送方的传输协议是否支持 ECN；另一个是 CE（Congestion Experienced）位，由路由器设置，以显示是否发生了拥塞。必须将这两个位结合起来实现ECN功能，具体包括以下几种组合。

- 00：发送主机不支持ECN。
- 01 或者10：发送主机支持ECN。
- 11：路由器正在经历拥塞。

一个支持ECN的主机发送数据报时将ECN字段设置为01或者10。对于支持ECN的主机发送的数据报，如果路径上的路由器支持ECN并且经历拥塞，它将ECN字段设置为11。如果该数值已经被设置为11，那么下游路径上的路由器不会修改该值。

### 首部校验和

IP数据报在传输过程中并不对其数据进行校验，主要有两个方面的原因，一是作为一个点对点协议，在传输过程中每个点都对数据进行校验操作会增加很大的开销；二是留给更高的层次去解决，既可以保证数据的可靠性，又可以得到更大的灵活性和效率。IP数据报首部中的部分字段在点对点的传输过程中是不断变化的，只能在每个中间点重新形成校验数据，在相邻点之间完成校验。首部通过校验和来保证其正确性，具体方法如下。

（1）发送方将IP数据报首部按顺序分为多个16位的小数据块，首部校验和字段的初始值设置为0，用1的补码算法对16位的小数据块进行求和，最后再对结果求补码便得到了首部校验和。

（2）将经过计算得到的首部校验和填写到数据报的首部校验和字段，封装成帧后发给通往目的地的下一跳设备。

（3）下一跳设备作为接收方将收到的IP数据报的首部再分为多个16位的小数据块，用1的补码算法对16位的小数据块进行求和，最后再对结果求补码，若得到的结果为0，就验证了数据报首部的正确性。

:::tip 提示
发送方用1的补码计算和数时，首部校验和字段被设置为0，等于没有参加计算，求补码后的校验和与校验和和数各位正好相反。接收方用1的补码计算和数时，由于新的首部校验和字段已经被加入，在首部未发生变化的情况下所得的和数应该为 0xffff，因此求补码后的结果应该为0x0000。
:::

### 验证IP首部信息

大多数 TCP/IP 通信都建立在 IP 协议之上，可使用协议分析工具抓取 IP 数据包。这里使用Wireshark抓取一个浏览网页过程中的数据包，展开某个HTTP数据包中的IP数据报，结果如下图所示。可对照前述字段说明来分析验证。

![image](./assets/ip-10.png)

其中的服务类型字段已变成了差分服务字段（Differentiated Services Field），DSCP和ECN各位显示非常明晰，这里使用的是目前常用的默认设置00000000。

首部校验和已证明校验正确（Header checksum：0x7620 [correct]）。

## IP数据报分片与重组

IP数据报最大长度可达65535（216-1）字节，但很少有底层的物理网络能够封装如此大的数据包，因此将IP数据报分片传输，目的主机将分片重组还原为一个数据报。

### 最大传输单元（MTU）

层物理网络能够封装的最大数据长度称为该网络的最大传输单元（Maximum Transmission Unit，MTU）。当数据报封装成帧时，数据报的总长度必须小于MTU，如下图所示：

![image](./assets/ip-11.png)

对于不同的物理网络协议，MTU的值是不同的。表4-3给出了不同协议的MTU值。物理网络的MTU是由硬件决定的，通常网络的速度越高，MTU也就越大。

![image](./assets/ip-12.png)

IP数据报在从源节点到目的节点的传输过程中往往要经过多个不同的网络。由于各种物理网络存在着差异，对帧的最大长度有不同的规定，各个物理网络的最大传输单元 MTU 可能不同。如果IP数据报正好能封装在一个帧中从源节点传到目的节点，这当然是最理想的，但实际运行中很难保证这一点。将一个数据报封装在具有较大 MTU 的物理网络帧中发送时，可能在穿过较小MTU的物理网络时无法正常传输。解决这个问题有两种方案，一是将数据报按照从源节点到目的节点的最小 MTU 进行封装，这种方案不能充分利用网络的传输能力，传输效率不够高；二是将数据报先以源节点所在网络的MTU进行封装，在传输过程中再根据需要对数据报进行动态分片，这要求网络支持这种特性。TCP/IP 协议采用的是后一种方案，即数据报分片。分片的英文为Fragmentation，国内有的译为分段。

### 数据报分片

当IP层要传送的数据大于物理网络的最大传输单元时，必须将IP数据报分片传输。分片就是将一个数据报划分成若干更小的单元，以适应底层物理网络的MTU。

IP协议选择当前源主机所在物理网络最合适的数据报大小来传输数据。当该数据报需要穿过MTU较小的网络时，将数据报分成较小数据片进行传输。已经分片的数据报通过具有更小MTU的网络，还要对数据报进一步分片。数据报在从源到目的地的过程中可能会有多次分片。

数据报分片时，每个分片都会得到一个首部。分片首部的大部分内容和原数据报相同，如IP地址、版本号、协议和标识等，所不同的主要是标志、总长度和分片偏移3个字段。分片可以带、也可以不带原数据报的选项。当然，不管是否进行分片，校验和的值总是要重新计算。

标识（Identification）字段提供分片所属数据报的关键信息，是分片重组的依据。为了保证唯一性，IP 协议使用一个计数器来标识数据报。当 IP 协议发送数据报时，就把这个计数器的当前值复制到标识字段中，并把这个计数器的值加 1。当数据报被分片时，标识字段的值就复制到所有的分片中。也就是说，同一数据报的所有的分片具有相同的标识，也就是原始数据报的标识。目的主机必须将所有具有相同标识的分片组装成一个数据报。

标志（Flags）字段占3位，用于表示该IP数据报是否允许分片以及是否是最后的一个分片，格式如下图所示：

![image](./assets/ip-13.png)

分片偏移字段指出本片数据在原始数据报数据区中的相对位置。由于各分片独立传输，到达目的主机的顺序无法保证，需要分片偏移字段为重组提供顺序信息。该字段占13位，以8字节为度量单位。例如，一个具有4000字节数据的数据报被划分为3个分片，在原始数据报中的数据编号是0～3999。第1个分片携带的数据是字节1～1399，分片偏移值是0/8 = 0；第2个分片携带的数据是字节1400-2799，分片偏移值是1400/8 = 175；第3个分片携带的数据是字节2800～3999，分片偏移值是2800/8=350。

因为分片偏移字段只有13位长，它不能表示超过8191的字节数。主机或路由器将数据报进行分片时，必须选择合适的分片长度，每片第1个字节数应当能够被8整除。

:::tip 提示
分片必须满足两个条件，一是各分片尽可能大，但必须能够为帧所封装；二是分片中数据的大小必须为8字节的整数倍，否则IP无法表达其偏移量。
:::

### 分片的重组

同一数据报各个分片到达目的地，必须被重组为一个完整的数据报。目的主机在进行分片重组时，采用一组重组定时器。开始重组时即启动定时器，如果重组定时器超时仍然未能完成重组（由于某些分片没有及时到达目的主机），源主机的IP层将丢弃该数据报，并产生一个超时错误，报告给源主机。

IP 协议主要依据数据报首部中的标识、标志和分片偏移字段进行分片重组。同一标识的分片应归并到一个数据报，重组的分片依据分片偏移量的顺序排列。第 1 个分片的分片偏移值是0；将第1个分片长度除以8，结果就是第2个分片偏移值；将第1个和第2个分片的总长度除以 8，结果就是第 3 个分片偏移值；依此类推。标志字段中的 D 位决定到达的数据报是否分片，M 位决定是否最后一个分片。实际应用中数据报的分片和重组操作由网络操作系统自动完成。

分片可以在源主机或传输路径上的任何一台路由器上进行，而分片的重组只能在目的主机上进行。因为各分片作为独立数据报进行传输，在网络中可能沿不同的路径传输，在中间的某一个路由器上收齐同一数据报的各个分片不现实。另外，不在中间进行重组可以简化路由器上的协议，有助于减轻路由器的负担。

### 查看和验证数据报分片与重组

要通过协议分析工具抓取 IP 数据报分片与重组过程中的数据包，必须构造一个较大的数据包。常用的ping命令传送的ICMP回送与应答报文，会封装到IP数据报中进行传递，该命令可指定要发送的数据的字节数，可以产生一个较大的数据包。这里在Windows计算机上执行带参数“-l 4096”的ping命令测试到另一台主机的连通性，使用Wireshark抓取执行过程中的一系列数据包。相关的数据包列表如下图所示，请求和应答报文都被IP协议进行分片和重组。

![image](./assets/ip-14.png)

例中以太网仅支持1500字节的MTU，要传送数据长度为4096字节的数据报，必须将其进行分片。这里对其中一个数据报的分片与重组进行详细分析，涉及3个数据包。展开序号为3的数据包的IP协议树，如下图所示，数据总长度为1500（以太网的MTU），标识为0x0206，标志字段指示可以分片且有更多分片（More Fragments），分片偏移值0说明是第1个分片，数据部分长度为1480字节（因为还有20字节的首部）。

![image](./assets/ip-15.png)

展开序号为4的数据包的IP协议树，如图4-10所示，数据总长度仍为1500，标识仍为0x0206，标志字段指示可以分片且有更多分片，分片偏移值 1480 说明不是第 1 个分片，数据部分长度为1480字节。这里需要注意的是，Wireshark解析的分片偏移值以字节（8位）为单位，而RFC 791规定8字节（64位）为单位。

展开序号为5的数据包的IP协议树，如图4-11所示。数据总长度为1164（不够1500），标识仍为 0x0206，标志字段指示没有更多分片，说明是最后一个分片；分片偏移值 2960。这里列出来IP数据报分片的汇总情况，各帧携带的实际负载（数据），共有3个分片，整个数报分成3个部分。例中重组之后的数据报总长度为4104，而ICMP协议树显示的实际传输的数据为4906，这是因为还有8个字节是ICMP报文首部。对于ICMP协议来说，整个报文通过IP分片得以顺利送达。

![image](./assets/ip-16.png)

综上所述，对数据报进行分片必须改变标志、分片偏移和总长度3个字段的值，其余各字段必须被复制，另外校验和的值总是要重新计算。

![image](./assets/ip-17.png)

## IP主要选项介绍

### 选项列表结束与无操作

选项列表结束（End of Option List）选项用于在选项列表末尾进行填充，只能使用一次，而且只能用于最后一个选项。它只有1个字节，选项类型值为0，格式如下：

![image](./assets/ip-18.png)

无操作（No Operation）选项用作选项之间的填充，但是它通常用在另一个选项之前。例如，可用来使下一个选项在32位边界上对齐。它也只有1个字节，选项类型值为1，格式如下。

![image](./assets/ip-19.png)

当需要多个字节对选项进行填充时，先用多个无操作选项进行填充，最后用选项列表结束选项结束整个选项。

### 严格源路由与宽松源路由

源路由指由源主机预先确定数据报穿越网络的路由，而不是由路由器自动选择路由。这样可以使数据报绕开出错网络，或者对特定网络的吞吐率进行测试。IP协议提供了两种源路由选项：严格源路由和宽松源路由。

（1）严格源路由。

严格源路由（Strict Source and Record Route，SSRR）选项要求源主机上的发送方指定数据报必须经过每一个路由器。IP数据报必须严格按照发送方规定的路由经过每一个路由器。这些指定的路由器的顺序不能改变，每两个指定的路由器之间不能有未指定的路由器。如果数据报无法直接到达下一跳指定的路由器，路由器就会丢弃该数据报，然后产生一个源路由失败的目的地不可达报文，并向源主机报告。该选项按照英文名称应译为严格源及记录路由，这是因为在数据报沿路由发送过程中对IP地址清单进行了更新。

严格源路由选项的格式如下：

![image](./assets/ip-20.png)

选项类型字段值为137（10001001），其中复制标志为1表示分片时该选项要复制到各个分片；选项类为00，选项编号为01001。

选项长度字段值是该选项的长度。

指针字段占1字节，指向要处理数据报的下一个路由器地址的开始处。指针字段值是相对于该选项的偏移量，最小值为4，即源主机发送数据报时的指针。

路由数据是用于指定路由的 IP 地址列表，由于数据报首部长度的限制，IP 地址表中最多只能有9个IP地址项。发送IP数据报前必须填充IP地址表。

按照源路由传输数据报的过程中，数据报的目的IP地址会不断变化，而且选项中的源路由IP地址表也会发生变化。源主机从上层收到源路由IP地址表后，将第1个IP地址从路由数据中去掉（该地址作为当前数据报的目的地址），再将剩余的表项前移，然后将最终目的地的IP地址作为源路由IP地址表的最后一条。指针仍然指向IP地址表的第1项，即指针值为4。每个收到数据报的路由器将指针所指的IP地址与抵达路由器的接口IP地址相比较，如果不同，则丢弃这个数据报，并发出差错报文；如果一致，而指针值不大于长度值，则处理这个数据报，用源路由中下一个地址替换目的地址字段中的地址，用记录的路由地址（记录的路由地址是指IP模块自己的IP地址，也就是数据报被转发的地址）替换刚用过的源路由地址，指针值增加4，然后转发这个数据报。如果指针值大于长度值，源路由为空和记录的路由已满，则基于目的地址字段中路由数据报进行。

（2）宽松源路由。

宽松源路由（Loose Source and Record Route，LSRR）选项与严格源路由相似，只是要求没那么严格，所指定的路由仅限于某些关键路由器，关键路由器之间无直接物理连接时，可通过路由器的自动路由选择功能进行补充。宽松源路由选项的格式如下。

![image](./assets/ip-21.png)

### 记录路由

记录路由（Record Route）选项用于记录数据报从源主机到目的主机所经过的路由上各路由器的IP地址。记录路由选项格式如下：

![image](./assets/ip-22.png)

这与源路由选项格式基本相同，只是选项类型为7（00000111）。

路由数据（IP 地址表）的大小由源主机根据对地址数的估计预先分配，最多只能有 9 个 IP地址项。源主机创建一些空字段，预留给要记录的的IP地址。当数据报离开源主机时，所有这些字段都是空的。指针字段的值是4，指到第1个空字段。当数据报在向前不断转发时，处理这个数据报的每一个路由器把指针值与长度值相比较。若指针值大于长度值，则选项是满的且没有改变。但是若指针值不大于长度值，路由器就在下一个空字段中插入其转发出的IP地址，并将指针值增加4。如果分配的地址表的空间不足以记录下全部路径，IP软件将不记录多余的IP地址。

###时间戳

时间戳（Internet Timestamp）选项用于记录数据报经过各路由器时的时间，根据时间戳可以估算数据报从一个路由器到另一个路由器所花费的时间，有助于分析网络的吞吐率和负载情况。时间戳选项格式如下图所示：

![image](./assets/ip-23.png)

选项类型为 68（01000100），可见时间戳选项在分片时不复制到各个片，该选项仅在第 1 个分片中出现。

指针字段是从该选项开始到时间戳结束的字节数加 1，即指向下一个时间戳的空白处。最小的指针值是5。当指针值大于选项长度值时，时间戳区域已经填满。

溢出字段用于记录因空间不够而未能登记时间戳的IP模块数。若溢出计数本身溢出，路由器将丢弃数据报，并产生ICMP协议参数错报文发送给源主机。

标志字段用于定义时间戳选项的格式。标志值为0时，表示仅记录所经过的路由器的时间戳；标志值为 1 时，表示同时记录路由器转发出口的 IP 地址和时间戳；标志值为3时，表示只记录指定IP地址的路由器的时间戳。

选项中的每个时间戳为32位，采用世界时间（UT）表示，从午夜起开始计时，单位为毫秒。如果时间不以毫秒计算，或不能提供以世界时间午夜为基准，那么就要将时间戳的最高位设置为1，表示这不是一个标准值。由于Internet各路由器的时钟无法严格同步，因此时间戳信息只能作为参考。

## IP软件实现与模块分析

便于进一步理解IP协议功能和运行机制，下面介绍一种简化的IP软件实现方案，该方案省略了IP选项的处理。如下图所示，整个方案包括8个基本模块：添加IP首部模块、处理模块、路由选择模块、分片模块、重组模块、路由表、MTU表以及分片重组表，其中处理模块是核心，进出的数据都需要它来处理。

![image](./assets/ip-24.png)

IP协议收到从上层（如TCP、UDP）传下来的数据，首先由添加IP首部模块添加IP首部后再将其封装成IP数据报，然后交给处理模块，由处理模块判断是否是环回地址或以本机IP地址作为目的地址的数据报，如果是则直接向上传回上一层。如果不是，则是需要外发出去的数据报，要通过路由选择模块进行路由选择，然后再交给分片模块去处理，分片模块根据路由所选择的网络接口完成数据包分片，并将分片后的数据报交给下一层处理。

IP协议收到来自下层（链路层）的数据，首先由处理模块对其进行常规处理，如校验、IP选项处理等，如果本机是该数据报的目的主机，则向上层提交（根据协议标识进行分用）；如果是需要转发的数据报，则通过路由选择模块进行路由选择，然后交给分片模块处理，最后交给下一层处理。

## IP数据包构造

netwox工具提供编号为38的模块，用来构造IP数据包。用户不仅可以设置源IP地址和目标IP地址，还可以设置TTL、数据分片等字段。

### 示例1：根据IP地址构造IPv4数据包

#### (1) 不指定选项运行

执行命令如下:

```bash
C:\Program Files (x86)\netw\netw539>netwox 38
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen             |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________|
|              id               |r|D|M|       offsetfrag        |
|_________0xB4EE=46318__________|0|0|0|________0x0000=0_________|
|      ttl      |   protocol    |           checksum            |
|____0x00=0_____|____0x00=0_____|____________0x38DA_____________|
|                            source                             |
|_________________________192.168.0.108_________________________|
|                          destination                          |
|____________________________5.6.7.8____________________________|
```

在输出信息中，第一行IP表示当前数据包是基于IP协议的。包中的字段值均为默认值。例如，源IP地址为192.168.0.108，目的IP地址为5.6.7.8。

#### (2) 指定源目IP地址

执行命令如下：

```bash
C:\Program Files (x86)\netw\netw539>netwox 38 -l 192.168.0.132 -m 192.168.10.101
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen             |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________|
|              id               |r|D|M|       offsetfrag        |
|_________0xFD3E=64830__________|0|0|0|________0x0000=0_________|
|      ttl      |   protocol    |           checksum            |
|____0x00=0_____|____0x00=0_____|____________0x3172_____________|
|                            source                             |
|_________________________192.168.0.132_________________________|
|                          destination                          |
|________________________192.168.10.101_________________________|
```

#### (3) 抓包验证构造的IP数据包

![image](./assets/ip-2.png)

### 示例2：根据MAC地址构造IPv4数据包

netwox工具提供编号为34的模块，用于指定IP数据报的以太层字段信息。

#### (1) 不指定选项，直接运行该模块，查看默认设置

执行命令如下：

```bash
C:\Program Files (x86)\netw\netw539>netwox 34
Ethernet________________________________________________________.
| F8:94:C2:D8:08:28->00:08:09:0A:0B:0C type:0x0800              |
|_______________________________________________________________|
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen             |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________|
|              id               |r|D|M|       offsetfrag        |
|_________0x6D05=27909__________|0|0|0|________0x0000=0_________|
|      ttl      |   protocol    |           checksum            |
|____0x00=0_____|____0x00=0_____|____________0x80C3_____________|
|                            source                             |
|_________________________192.168.0.108_________________________|
|                          destination                          |
|____________________________5.6.7.8____________________________|
```

在输出信息中，第一行Ethernet表示当前数据包的以太网层字段信息。这些字段值均为默认值。例如，当前以太网的源MAC地址为F8:94:C2:D8:08:28，目标MAC地址为00:08:09:0A:0B:0C。

#### (2) 指定以太网的源MAC地址和目标MAC地址

执行命令如下：

```bash
C:\Program Files (x86)\netw\netw539>netwox 34 -a 00:0C:29:C4:8A:DE -b 00:0C:29:D0:21:23
输出信息如下：
Ethernet________________________________________________________.
| 00:0C:29:C4:8A:DE->00:0C:29:D0:21:23 type:0x0800                   |
|_______________________________________________________________     |
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen                  |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________     |
|              id                       |r|D|M|       offsetfrag     |
|_________0x6983=27011__________|0|0|0|________0x0000=0_________     |
|      ttl      |   protocol    |           checksum                 |
|____0x00=0_____|____0x00=0_____|____________0x492E_____________     |
|                                   source                           |
|____________________________192.168.59.131_________________________ |
|                                destination                         |
|____________________________192.168.59.156__________________________|
```

#### (3) 验证构造的数据包，使用Wireshark工具捕获数据包

![image](./assets/ip-3.png)

## 利用分片实施洪水攻击

IP协议在传输数据包时，经常会进行分片传输。例如，当一个设备准备传输一个IP数据包时，它将首先获取这个数据包的大小，然后获取发送数据包所使用的网络接口的**最大传输单元值（MTU）**。如果数据包的大小大于MTU，则该数据包将被分片。将一个数据包分片包括下面几步：

（1）设备将数据包分为若干个可成功进行传输的数据包。

（2）每个IP数据包的首部的总长度域会被设置为每个分片的片段长度。

（3）更多分片标志将会在数据流的所有数据包中设置为1，除了最后一个数据包。

（4）IP数据包头中分片部分的分片偏移将会被设置。

（5）数据包被发送出去。

目标主机收到分片包后，会根据分片信息重组报文。如果发送大量的无效IP分片包，会造成洪水攻击。用户可以使用netwox工具中编号为74的模块实施洪水攻击。

::: tip 提示
执行命令后没有任何输出信息，但是会向目标主机发送大量的IP分片数据包。如果使用Wireshark工具抓包，可以捕获到大量的IP分片数据包，如下图所示。图中显示了大量的IPv4数据包，Info列中的Fragmented IP protocol信息表示数据包为IP分片数据包。
:::

![image](./assets/ip-4.png)
