# 路由选择协议

## 路由选择协议概述

### 路由算法的设计考虑

路由算法是路由选择协议的核心。路由算法指明了计算机网络中的结点机（或路由器）在接收到一个分组之后，应选择哪条输出链路的策略。当采用虚电路通信时，路由是在建立呼叫连接时确立的，即一次性确定路由，后继的分组均沿着这条既定的路由传送。当采用数据报通信时，结点机要为每个分组做出路由选择。因此，通信子网采用不同的通信方式，路由算法的使用频度是不一样的。

一个实际的路由算法不可能做到尽善尽美，只能比较接近于理想的路由算法。而一个理想的路由算法应具有以下一些特点：

① 正确性。指路由算法指明的路由最终一定能够到达目的网络和目的主机。

② 简单性。简单的路由算法不仅可以缩短结点机（或路由器）进行路由选择的计算时间（即缩短分组的结点时延），还能减少为路由选择计算而增加的网络通信开销。

③ 适应性。指路由算法能够适应包括通信流量和软、硬件故障在内的网络状态变化，自适应地改变路由，确保网络仍能正常运行。

④ 稳定性。当网络通信量和拓扑结构发生变化时，稳定性将能使路由算法得到一个收敛的可接受的解，不至于发生振荡，这是一个十分重要却易被忽视的特性。

⑤ 公平性。算法对所有用户都平等对待，以达到网络内部流量的平衡分布。

⑥ 最佳性。指实现路由算法所花费的开销最低。衡量开销的因素可以是跳数、带宽、时延、负载、费用等。当然不存在绝对的最佳路由算法，所谓“最佳”只能是在某一特定条件下做出较为合理的选择。

在设计路由算法时，应综合考虑上述特点，但在不同的应用条件下，可以有所侧重。应当指出，路由选择是个非常复杂的问题，因为它涉及网络中的所有主机、路由器、通信线路。同时，网络环境也随时会发生变化，这种变化（如网络故障）又无法事先知道。如当网络发生拥塞时，路由选择算法就应具有缓解拥塞的能力，但此时却难以从网络中的各结点获取所需的路由选择信息。

根据路由选择策略是否自适应网络状态（如通信量、网络拓扑等）的变化，路由算法可分为两大类：非自适应的和自适应的。非自适应的路由算法是不会根据当前网络流量和拓扑结构的变化来调整路由策略，又称**静态路由**算法。**静态路由算法常用的有：洪泛法、固定路由法和查表选择法等**。自适应的路由算法则会根据当前网络流量和拓扑结构的变化自动调整路由策略，又称**动态路由**算法。当然，不同的自适应路由算法又因获取信息的来源、改变路径的策略、用于优化的度量的不同而有所不同。**动态路由算法常用的有：孤立选择法、集中选择法和分布选择法等。**

### 路由决策的类型

路由决策有三种基本类型：集中式路由决策、静态路由决策和动态路由决策。这三种路由决策类型在因特网中都得到了应用。

（1）集中式路由决策

集中式路由决策指所有路由决策均由网络中一台计算机（或路由器）做出。集中式路由决策的最大优点是比较简单。它通常用在基于主机的应用体系结构中。

（2）静态路由决策

静态路由决策指路由决策由单个计算机（或路由器）以一种固定的方式做出。此时，路由表由网络管理员开发，而且只有当网络的状态发生变化时（如计算机的入网和出网、网络线路的增删等），才会变更路由表。静态路由通常用于网络变化少、路由操作少的场合。

由于静态路由决策是非集中式的，它意味着网络中的所有计算机（或路由器）遵循路由选择协议做出自己的路由决策。多数静态路由算法具有自适应性。在城域网和广域网中，每台计算机的路由表是由其各自的网络管理员开发的。在局域网或骨干网中，网络上使用的路由表通常由网络管理员或网络管理员小组开发。

（3）动态路由决策
动态路由（又称自适应路由）决策指路由决策由计算机以一种非集中式的方式做出。当网络中存在多条路径时，动态路由决策有利于做出最佳路径的选择。动态路由决策试图通过远离运行繁忙的线路和计算机来提高网络的性能。当然，最初的路由表是由网络管理员开发的，但路由表会由计算机自身进行持续不断地更新，反映网络不断变化的实际情况。
动态路由决策存在两点不足：一是与集中式路由决策相比，它需要网络中每台计算机（或路由器）更多地用于处理路由表，从而降低了网络的性能；二是路由信息的传输“浪费”网络的带宽。

### 因特网路由选择协议

由于因特网的规模非常大，如果让所有的路由器知道分组是如何通过整个网络送达的，那么路由表的规模就会非常大，处理起来要花费太多的时间。而且，所有路由器之间为交换路由信息也将给因特网带来很大的通信量。另外，许多单位一般不愿意外界了解本单位网络的布局细节及选路技术，但却又希望将本单位的网络连接到因特网上。因此，因特网将整个互联网划分为若干个较小的自治系统AS（Autonomous System）。自治系统的经典定义是：在单一的技术管理下的一组路由器，使用一种AS内部的路由选择协议和共同度量来确定分组在该AS内的路由，同时还使用一种AS之间的路由选择协议来确定分组在AS间的路由。其实，现在一个自治系统内也采用多种内部选择协议和多种度量来进行路由选择。所以，现在对自治系统仅强调：一个自治系统对外表现出一个单一的和一致的路由选择策略。如果一个自治系统的规模较大，还可将其再进一步地划分。因此，一个自治系统最重要的特点是它有权自主地决定本系统内应采用何种路由选择协议。

因特网采用的路由选择协议是层次式的、自适应的分布式路由选择协议。因特网把路由选择协议划分为两大类，即① 内部网关协议IGP（Intrior Gateway Protocol）。指在一个自治系统内部使用的路由选择协议，与在互联网中的其他自治系统选用什么路由选择协议无关。目前这一类路由选择协议有多种，如RIP和OSPF等。② 外部网关协议EGP（External Gateway Protocol）。当源主机和目的主机在不同的自治系统中（这两个自治系统可能使用不同的内部网关协议），数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传送到另一个自治系统中。这样的协议称为外部网关协议EGP。目前使用最多的外部网关协议是BGP的第4版。

![image](./assets/route-1.png)

## 内部网关协议

因特网最初使用的内部网关协议是路由信息协议RIP（Routing Information Protocol），是从APRANET继承过来的，并在小系统中得到广泛使用。但是，随着自治系统AS的逐步扩大及协议存在的不足，后来它就被一个称为开放最短通路优先协议OSPF（Open Shortest Path First）的链路状态协议取代了。OSPF于1990年成为因特网标准，并且得到许多制造商的支持。

内部网关协议无论是RIP，还是OSPF都有一个的共同特点，即每一个路由都要与其他路由器不断地交换路由信息。因此，学习这些协议时必须注意以下三个要点：①路由器仅与相邻的路由器交换路由信息；②路由器交换的是当前本路由器所知道的全部路由信息，即自身路由表的全部内容；③路由器按照规定的时间间隔（如30秒），或者当网络拓扑发生变化时，才与相邻的路由器交换路由信息。

下面我们介绍这两种内部网关协议。

### 路由信息协议（RIP）

#### （1）基本原理

RIP是一个基于距离向量的分布式路由选择协议。此协议要求网络中的每一个路由器都要保存从它自己到其他每一个目的网络的“距离”记录，这一组距离也就是距离向量。RIP协议对“距离”（又称“跳数”）的定义是：从一个路由器到直接连接的网络的距离定义为 1。从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加1。RIP认为一条好的路由就是它经历的路由器的数目少，也就是说“距离短”。RIP允许一条路由最多只能包含15个路由器。因此“距离”的最大值为16时即相当于不可达。

RIP不能在两个网络之间同时使用多条路由，而只选择一条具有最少路由器的路由，即使还存在另一条高速（低时延）但路由器较多的路由。

RIP的工作原理是：互联网中的每一个路由器每隔规定的时间便向相邻路由器广播自己的路由表。每一个路由器根据其相邻路由器发送来的路由信息，逐步建立并不断更新自己的路由表。这里，所谓相邻路由器就是连接在同一个网络上的两个路由器。路由表中最主要的信息是到某个网络的最短距离，以及应经过的下一站路由器地址。路由表更新的原则是使得到每个目的网络的距离最短。其更新算法称为距离向量算法。

这里需要指出的是，RIP协议是使用传输层的用户数据报UDP进行传送的。因此从协议层次来看，RIP协议的位置应当在应用层。当各路由器交换路由信息时，每一个路由器相当于网络上的主机，因此它的协议栈有5层。但是，路由器在转发IP数据报的过程只用到网络层，这时它的协议栈只有下三层。

下面我们先介绍RIP协议的报文格式，然后再说明距离向量算法。

#### （2）RIP的报文格式

现在使用的RIP协议版本是1998年11月公布的第2版（RFC 2453），已成为因特网的标准。该版本支持变长子网和CIDR，还提供简单的鉴别功能以支持多播的功能。RIP报文由首部和路由部分组成，下图表示RIP2报文的格式。

![image](./assets/route-2.png)

RIP首部占4字节。其中，命令字段指出报文的含义，如路由信息请求、路由信息响应、路由更新等。版本字段指出协议所用的版本。首部的第3个字段作为填充之用，使首部4字节字对齐。

RIP 报文的路由部分由若干条路由信息组成。每一条路由信息占 20 字节，其中包括：地址族标识符（又称地址类别，16 位）表示所用的地址协议，如采用 IP 地址则赋值为 2。路由标识（16 位）表示自治系统的编号，由因特网号码指派机构分配。还有网络地址、子网掩码、下一跳路由器地址和距离。每一个 RIP 报文最多可包含 25 条路由信息，因此 RIP报文的最大长度为4+25×20=504字节。

RIP2具有简单的鉴别功能。使用鉴别功能时，第一条路由信息（20字节）用于鉴别，其中地址族标识符置为全“1”，路由标识填入鉴别类型，其余16字节为鉴别数据。此时，一个RIP报文只能填入24条路由信息。

#### （3）距离向量算法

距离向量算法基于Bellman-Ford算法。Bellman-Ford算法的基本要点是：设X是结点 A到结点B最短路径中的一个结点，把路径A→B拆分成两段路径，即A→X和X→B，那么每一段路径A→X和X→B也分别是结点A到X和结点X到B的最短路径。

距离向量算法可具体描述如下：

当路由器收到相邻路由器（地址为X）发送来的RIP报文时，进行下列步骤：

① 修改此RIP报文中的所有表行项目：首先把“下一跳路由器地址”字段改为X，其次把“距离”字段的值加1，以便更新本路由器的路由表。每个表行项目中有三个内容，即目的网络地址N、距离d和下一跳路由器地址X。

② 对修改后的RIP报文中每一个表行项目进行下列操作：

若原来路由表中没有目的网络地址 N，则把该表行项目添加到路由表中，表示这是一个新加入的网络；

否则，因路由表中有目的网络地址N，就查看“下一跳路由器地址”项，

若下一跳路由器的地址为X，则把收到的项目替换原路由表的项目，因为这是最新的路由信息；

否则，因下一跳路由器的地址不是X，就要查看“距离”项，

若收到的项目中的距离d小于路由表中的距离，则更新成更短的路由；

否则，什么也不做，表示不必更新原来的更短路由。

③ 若3分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记做不可达路由器，也就是把距离置为16（距离为16时，表示不可达）。

④ 返回。

【例】已知路由器R5的路由表如图（a）所示。现路由器R5收到相邻路由器R4发来如图（b）所示的路由更新信息。试问：路由器R5如何更新它的路由表?

![image](./assets/route-3.png)

【解】先把上图（b）中的距离都加1，并把下一跳路由器都改为R4，得出下图（a）所示的路由信息更新表。下面把它与上图（a）中的各表行的项目相对照，可得结论如下：第1、4行更新信息在上图（a）中没有，应添加到此表中。第2行更新信息在上图（a）中有，虽下一跳路由器也是R4，但距离已增大为5，因此需要更新。第3行更新信息在上图（a）中也有，但下一跳路由器改为R4，且距离缩短为2，因此也需要更新。这样经更新之后，路由器R5的路由表如下图（b）所示。

![image](./assets/route-4.png)

必须指出，在路由器刚刚开始工作时，该路由器只知道到直接相连的网络的距离（此距离定为1）。接着，每一个路由器都与相邻的路由器交换并更新路由信息，但经过若干次更新之后，该路由器就可知道它到本自治系统中的任一网络的最短距离和下一跳路由器的地址。RIP协议使得网络中的所有路由器都与相邻的路由器不断地交换路由信息，并不断更新其自身的路由表，从而达到每一个路由器到每一个目的网络的距离为最短（即跳数最少）。实际使用证明：使用RIP协议可使自治系统中所有路由器都能较快地得到正确的路由选择信息，亦即它的收敛过程较快。

#### （4）RIP存在的问题

RIP协议存在的问题是当网络出现故障时，其故障信息往往需要经历较长的时间才能传送到所有的路由器。出现这种情况的原因是，假设路由器R1到网络N1的链路突然出现故障，于是路由器R1把路由表中的相应表行的距离更改为16，但这一更新消息是要经过30秒后才能发送出去。而在此之前且又收到了相邻路由器R2发送来的路由更新报文，其中含有可达网络N1的信息，这样路由器R1从收到R2的更新报文中误认为可经过路由器R2到达网络N1，即更新自己的路由表再发送出去，这样的更新继续下去，直到R1和R2到网络N1的距离增大到16，方知网络N1是不可达的。RIP协议的这一传播消息的特点称为“好消息传播快，坏消息传播慢”。这里，所谓“好消息”是指可达消息，而“坏消息”则指不可达消息。

综上所述，RIP协议的最大优点是实现简单、开销较少。其主要缺点有：RIP协议把最大距离定为15，限制了网络的实际规模；路由器交换的路由信息是完整的路由表，随着网络规模的增大，开销也随之增加；由于“坏消息传播慢”，使得更新过程的收敛时间过长。由此可见，RIP协议仅适用于规模较小的网络。

### 开放最短通路优先协议（OSPF）

#### （1）基本特点

随着因特网规模的不断扩大，RIP协议的缺点渐趋明显。为了克服RIP协议存在的缺点，于1989年开发出开放最短通路优先OSFP（Open Shortest Path First）协议，目前OSPF2已成为因特网标准协议（RFC 2328）。由于多数路由器制造商都支持OSFP，它已成为最主要的内部网关协议。

OSFP协议采用了“开放”的设计思想，并使用了Dijkstra所提出的最短通路算法。它的主要特征是它是一种分布式的链路状态协议（link state protocol），其基本特点是：

① 路由器采用洪泛法向本自治系统中的所有路由器发送路由信息。所谓洪泛法是指路由器把收到的信息通过除输入链路之外的所有输出链路转发给相邻的路由器，而且每一个相邻路由器又将收到的信息再次发往相邻的路由器。路由器依据链路状态数据库中的数据，使用Dijkstra算法计算出自己的路由表。仅当链路状态发生变化，路由器才用洪泛法向所有路由器发送路由信息，路由器据此计算路由表，更新链路数据库。因此，OSFP的更新收敛过程较快。OSFP对“链路状态”的变化用一个32位的序号来表示，序号越大则状态越新。OSFP规定，链路状态序号的增长速率不得超过5s/次。按此计算，600年内不会产生序号重复。

② 所有的路由器都维持一个链路状态数据库。所谓路由器的“链路状态”是指该路由器与哪些网络或路由器相邻，以及该链路的“度量”。有时为了方便起见，也称“度量”为“代价”。OSFP用“度量”来表示费用、距离、时延、带宽等。这些均可由网络管理人员进行设定。OSFP可根据IP分组的不同类型对不同的链路设置成不同的代价。例如，对于非实时业务的高带宽卫星链路可设置为较低的代价，而对时间敏感的实时业务设置为较高的代价。链路的代价用一个无量纲的16位二进制数（相当于十进制数1～65535）来表示。

③ OSFP对于到同一目的网络存在多条相同代价的路径，可以进行通信量的分配，以达到多条路径间的负载平衡。

④ OSFP对路由器之间交换的路由信息具有鉴别的功能，保证了仅在可信赖的路由器之间交换链路状态信息。

⑤ OSFP支持变长子网划分和无分类编址CIDR。

由此可见，OSFP协议的工作原理与RIP协议不同。OSFP是依靠各路由器间频繁地交换信息动态地更新链路状态数据库，并维持这个数据库在全网范围内的一致性。每一个路由器都知道全网的拓扑结构和各链路的代价。每一个路由器使用链路状态数据库中的数据，构造出自己的路由表。

需要指出的是，OSPF分组不是用UDP而是直接用IP数据报传送的（注：IP数据报首部的协议字段值为89），可见OSPF协议的位置在网络层。且OSPF构成的数据报很短，这样做可减少路由信息的通信量，且不必将长的数据报进行分片传送。

#### （2）自治系统的划分

为了使OSPF能够用于规模较大的网络，OSPF将一个自治系统AS划分成若干个规模较小，且不重叠的区域（area）。一个区域是一个网络或一组邻近的网络，并以一个32位的区域标识符（用点分十进制）表示。一个区域内的路由器数目最好限制在200个以内，以免区域的规模过大。

划分区域的想法在于把利用洪泛法交换链路状态信息的范围局限在每一个区域之内，而不是整个自治系统，从而减少网络的通信量。OSFP采用层次结构的区域划分方法，每一个AS有一个主干区域（backbone area），称为0号区域，其标识符为 0.0.0.0。同一AS内的所有区域都连接到主干区域上，因此从AS的任何一个区域出发，经过主干区域，就可以到达该AS的其他区域。采用分层次划分区域的方法，虽然使交换信息的种类增加，同时也使OSFP协议更加复杂，但却使每个区域内的交换路由信息的通信量大大减少，这就使得OSFP协议能够用于规模很大的自治系统当中。

图6-23表示主干区域与其他区域之间的关系。图中，OSFP所使用的路由器有4种：

① 在一个区域使用的内部路由器（如R2、R5～R8）；

② 连接两个或多个区域的区域边界路由器（如R3、R4）；

③ 位于主干区域内的主干路由器（如R1～R4）；

④ 位于AS边界上的AS边界路由器（如R1）。

![image](./assets/route-5.png)

这些路由器允许兼用，如R3和R4既是主干路由器，也是区域边界路由器。显然，每一个区域至少有一个区域边界路由器。所有区域边界路由器都是主干区域中的路由器，反之，主干区域中的路由器不一定是区域边界路由器。

#### （3）OSFP分组的格式

OSFP分组由首部和数据部分组成，如下图所示。

![image](./assets/route-6.png)

首部的各字段的含义如下：

① 版本（8位）。指明OSFP协议的版本号，当前版本号为2。

② 类型（8位）。指明5种分组类型之一。

③ 分组长度（16位）。指明包含分组首部在内的长度（以字节为单位）。

④ 路由器标识符（32位）。表示发送该分组的路由器端口的IP地址。

⑤ 区域标识符（32位）。表示路由器所属区域的标识符。

⑥ 检验和（16位）。用于检测分组存在的差错。

⑦ 鉴别类型（16位）。目前只有两种，0（不用）和1（口令）。

⑧ 鉴别（64位）。鉴别类型为0时填入0，否则就填入8个字符的口令。

数据部分是某一种OSPF分组类型。OSPF共有5种分组类型：

① 问候分组（hello）。用于发现和维持邻站的可达性。OSFP规定，每两相邻路由器每隔10秒要交换一次问候分组，以便确知哪些邻站是可达的。因为只有可达邻站的链路状态信息才存入链路状态数据库，并由此计算出路由表。若40秒内没有收到某个相邻路由器发来的问候分组，则可认为该相邻路由器是不可达的，应立即修改链路状态数据库，并重新计算路由表。

② 数据库描述分组（database description）。向邻站提供自己链路状态数据库中的所有链路状态项目的摘要信息。

③ 链路状态请求分组（link state request）。向邻站请求发送某些链路状态项目的详细信息。

④ 链路状态更新分组（link state update）。用洪泛法向全网更新链路状态。路由器使用该分组类型将其链路状态通信邻站，以便更新路由表。链路状态更新分组共有5种，表示5种不同的链路状态。

⑤ 链路状态确认分组（link state acknowledgment）。对链路更新分组的确认。

上述后4种分组类型都是用来维持链路状态数据库的同步。所谓“同步”是指不同路由器的链路状态数据库的内容保持一致。两个同步的路由器称为完全邻接（fully adjacent）路由器。显然，相邻路由器与完全邻接路由器不是同一个概念。相邻路由器只强调物理上的相邻性，而完全邻接路由器既表明它们在物理上是相邻的，更强调它们的链路状态数据库的一致性。
当一台路由器刚启动时，它通过发送“问候”分组得知与它相邻的路由器是否工作。为了减少网络通信量，OSFP协议要求路由器使用“数据库描述”分组与相邻的路由器交换本数据库中已有的链路状态摘要信息。此后，路由器就可使用“链路状态请求”分组，向对方请求发送自己所缺少的某些链路状态项目的详细信息。通过一系列的这些分组交换，全网同步的链路数据库就建立起来了。

在网络运行过程中，每台路由器周期性地把“链路状态更新”分组发送给它的邻接路由器，此分组含有一个序列号。当邻接路由器收到后，以“链路状态确认”分组予以应答，并通过判别序列号来确定链路状态信息的新旧，从而决定是否更新路由表。当一条链路刚刚启用或停止使用，或者链路状态发生变化，路由器都要发送“链路状态更新”分组。为了确保链路状态数据库与全网的状态保持一致，OSPF规定每隔一段时间（如30分钟），要刷新一次数据库中的链路状态。

## 外部网关协议

外部网关协议自1989年起称为边界网关协议BGP（Border Gateway Protocol），它的较新版本BGP4是1995年公布的。BGP是不同自治系统的路由器之间交换路由信息的协议。

在介绍BGP之前，我们首先要说明为什么不同自治系统之间的通信不能使用前面介绍的 RIP或OSFP呢?这是因为内部网关协议主要考虑在一个自治系统中如何把数据报有效地从源站传送到目的站，而BGP的使用环境不同，它需要考虑自治系统之间的通信可使用多种路由选择策略的情况。这些策略涉及的因素有：①因特网的规模太大，使得自治系统之间的路由选择颇为困难；②在自治系统之间寻找最佳路由是不现实的，因为不同自治系统对“代价”的度量不同；③出于其他政治、经济和安全等方面因素的考虑。因此，BGP只能试图寻找一条能够到达目的网络的比较好的路由，而并非是要寻找出一条最佳的路由。BGP采用的是路径向量路由选择协议，它与基于距离向量的RIP和采用的链路状态协议的OSFP是有区别的。

从BGP路由器的角度，因特网是由一些BGP路由器及其连接线路组成的。在配置BGP路由器时，网络管理员要为每一个自治系统至少选择一个路由器作为该系统的“BGP发言人（BGP speaker）”。一般来说，两个BGP发言人通过一个共享网络连接在一起。BGP发言人除了必须运行BGP协议之外，还必须运行它所在自治系统使用的内部网关协议（如RIP或 OSFP）。BGP发言人往往是边界路由器，但也可以不是边界路由器。BGP发言人与其他自治系统的BGP发言人交换路由信息时，需先建立TCP连接（端口号为179），然后通过发送BGP报文来交换路由信息。BGP发言人所交换的路由信息其实就是到达某个网络（用网络前缀表示）所要经过的一系列的自治系统。换句话说，也就是网络可达性的信息。当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就可根据所采用的策略从收到的路由信息中找出到达各自治系统的较好的路由。图6-25表示BGP发言人与自治系统的关系。

由于BGP协议支持CIDR，所以在BGP的路由表中应包含目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各自治系统序列。在BGP路由器刚刚投入运行时，它与邻站交换整个路由表，但以后只当网络状态发生变化时才更新有变化的部分。这样做有利于节省网络带宽和减少路由器的处理开销。

下图表示BGP报文的格式。报文有一个19字节的首部，其中有三个字段：

![image](./assets/route-7.png)

① 标记（16字节）。用于鉴别收到的BGP报文。当不使用鉴别时，该字段置为全1。

② 长度（2字节）。指出包括通用首部在内的整个BGP报文的长度（以字节为单位），最小值为19，最大值为4096。

③ 类型（1字节）。分别表示所使用的4种报文，其值为1～4。

BGPv4使用的4种报文是：

① OPEN报文，用于与相邻的另一个BGP发言人建立关系，使通信初始化。

② UPDATE报文，用于发送一条路由信息或列出多条被取消的路由。

③ KEEPALIVE报文，用于确认OPEN报文，且周期性地证实邻站的连通性。

④ NOTIFICATION报文，用于发送检测到的差错状态。

BGP涉及三个功能性的过程：邻站获取、邻站可达和网络可达。连接到同一个网络上的两个BGP发言人被认为是邻站或对等站。如果两个邻站属于不同的自治系统，它们之间要交换路由选择信息，需由其中的一个邻站向另一个邻站发送OPEN报文，若后一个邻站接受这个请求，就发回一个KEEPALIVE报文予以响应，这一个过程称为邻站获取。一旦邻站关系确立，就可用邻站可达来维持这个关系。为了维持这种邻站关系，两个邻站需周期性地（一般是每隔30s）交换KEEPALIVE报文。最后一个过程是网络可达，每个BGP发言人都维持一个数据库，其中包含了它能够到达该网络的最佳路由信息。一旦这个数据库有所改变，该发言人就会向其他所有实现了BGP发言人广播一个UPDATE报文。通过此报文的广播，所有BGP发言人都能够建立和维持路由选择信息。当某一路由器或链路出现故障时，由于BGP发言人可以从不止一个邻站获得路由信息，因此很容易选择出新的路由，这样BGP协议较容易地解决了基于距离向量的RIP协议存在的“坏消息传播慢”的问题。

## 路由选择的关键部件——路由器

路由器在网络互连中得到广泛使用，始于20世纪80年代后期。因为互联网的规模越来越大，同时更多的异种网进行互连，网桥已无法适应这种环境。路由器则与网桥不同，是在网络层实现网间互连的，它可实现同类型或不同类型的网络互连。
其实，路由器是一种具有多个输入端口和多个输出端口的专用计算机，其主要功能是建立、维护和更新路由表，并实现网络间的分组转发。另外，路由器还具有数据处理功能（如分组过滤、分组转发、优先级、复用、加密、压缩和防火墙等）和网络功能。路由表根据路由算法产生，表中存储着可能的目的地址及如何到达目的地址的路由信息。路由器在转发分组时必须查询路由表，以确定将分组通过哪个端口转发出去。路由器的构成如下图所示。

![image](./assets/route-8.png)

如图所示，路由器由路由选择和分组转发两个部分组成。其中，路由选择部分的核心构件是路由选择处理机。该处理机的主要任务是根据所选用的路由选择协议构建路由表，并与相邻路由器交换路由信息，更新和维护此路由表。分组转发部分由交换结构、一组输入端口和一组输出端口组成。交换结构起着根据转发表对分组进行转发处理的作用。交换结构的具体实现方法有多种，常用的有通过存储器、总线和纵横交换结构三种方法。输入端口和输出端口在图6-27中各含有三个方块1、2和3分别表示代表物理层、数据链路层和网络层的处理模块。物理层处理模块进行比特的接收和发送。数据链路层处理模块按照链路层协议接收到达的帧，并去掉帧的首部和尾部，将其送往网络层处理模块。若帧的内容是路由交换信息则送往路由选择处理机，只有帧的内容是数据分组时才按首部中的目的地址查找转发表，把分组转发到合适的输出端口。网络层处理模块完成分组的转发功能。为了适应传输线路的传送速率，在网络层的处理模块中设有缓冲区，逻辑上它是一个队列结构。

按照路由算法的不同，路由表分为静态路由表和动态路由表。两者之间的根本区别在于路由表的内容是否随网络状态而变化。静态路由表是由人工建立的，网管人员将每个目的地址的路径输入路由表中，更新静态路由表也由人工进行，因此仅适用于小型的、结构不经常改变的局域网系统中。大型互联网通常采用动态路由表，在网络系统运行时，系统将自动运行动态路由选择算法建立路由表，网络结构发生变化时，路由表也随之自动更新。

路由器对动态路由表的管理是通过运行路由程序来完成的，这种路由程序也可分为静态和动态两种。在复杂的互连环境中，如果路由程序只收听其他路由器发来的路由表信息，而不广播自己的路由表，这种路由程序称为静态路由程序。反之，如果路由程序既收听来自其他路由器发来的路由表信息，又广播自己的路由表，则称为动态路由程序。路由程序通过收集来自其他路由器发来的路由表信息来动态地修改自己的路由表，从而适应网络环境的变化。

前面曾指出，路由表与转发表是有区别的。在互联网中，实现路由选择的路由表是由多个路由器按照路由选择算法协同工作构建起来的，路由表一般仅包含从目的网络到下一跳（以IP地址表示）的映射。而转发表是由路由表得出的，其中包含完成转发功能所需的信息，如要到达目的网络的转发端口以及某些MAC地址的映射。路由表和转发表应采用不同的数据结构来实现。路由表的结构需适应网络拓扑的变化，而转发表的结构则应使查找过程最优化。所以路由表总是用软件来实现，而转发表则可用特殊的硬件来实现。有时为了简便起见，在讨论路由选择原理时，并不区分路由表和转发表，而是笼统地用路由表这一名词。

路由器有多种分类方法，可按支持协议数目、服务类别、交换能力、结构、功能、应用、性能以及所处的网络位置等进行分类。例如，单协议路由器用于具有相同网络层协议的网络的互连；多协议路由器则可支持多种网络层协议，使用多协议路由器几乎可以使多家制造商提供的异种网络实现互连。
