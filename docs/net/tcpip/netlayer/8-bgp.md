# 边界网关协议（BGP）

**边界网关协议（Border Gateway Protocol，BGP）** 是一种用于**自治系统（Autonomous System，AS）** 之间的外部网关协议。当前使用的版本是BGP-4（规范文档更新至RFC 4271）。BGP-4作为事实上的Internet外部路由协议标准，被广泛应用于ISP之间。

作为一种外部网关协议，与 `OSPF`、`RIP` 等内部网关协议不同，`BGP` 的着眼点并不在于发现和计算路由，而在于控制路由的传播和选择最佳路由。`BGP`在路由器上可以两种方式运行，当运行于同一自治系统内部时称为`IBGP`（内部`BGP`）；当`BGP`运行于不同自治系统之间时，称为`EBGP`（外部`BGP`）。

运行`BGP`协议的互联网络如下图所示。

![image](./assets/bgp-1.png)

只有连接到多个ISP的网络才需要使用`BGP`。`BGP`是Internet主干网的重要组成部分，正是`BGP`让多个自治且协作的系统组成了目前的Internet。了解`BGP`的有关概念、原理以及数据格式，对于IP路由是非常必要的。

## BGP工作原理

`RIP`和 `OSPF`都是域内路由协议，适合在自治系统内部使用，但不能在自治系统之间使用。当运行区域变得很大时，这两种协议都变得不可操作，跳数增加使得距离向量路由变得不稳定；链路状态路由需要消耗非常大的资源来计算路由表。因此需要另一种路由协议来解决域间路由问题，`BGP`就是这样一种协议。

### 路径向量

`BGP`采用的是与 **距离向量算法** 类似的 **路径向量算法**，在该算法的路由表中包括目的网络、下一跳路由器和去往目的网络的路径，路径由一系列顺序的自治系统号构成。每一个自治系统可能有多条路径到达一个终点。例如，从 AS4 到 AS1 可以是 `AS4-AS3-AS2-AS1`，也可以是`AS4-AS3-AS1`。

自治系统的边界路由器利用`RIP`或`OSPF`等路由协议收集自治系统内部的各个网络的信息，不同自治系统的边界路由器交换各自所在的自治系统中网络的可达信息，这些信息包括数据到达这些网络所必须经过的自治系统的列表。路由器检验这些路径信息是否与管理员给出的一组策略一致，如果一致，路由器便更新其路由表，更新内容包括在路径中添加自治系统号和修改下一跳路由器。路由器在更新路由表时需要避免形成环路，这可以简单地通过判断路径中是否已经包含了该自治系统号来确定。

### 路由计算过程

在`BGP`中，每一个自治系统中至少有一个节点可以代表整个的自治系统，将它称为**发言者节点（Speaker Node）**。一个自治系统中的发言者节点创建一个路由表，并将它通知给相邻自治系统中的发言者节点。发言者节点通知的是在它的自治系统中或其他自治系统中的路径，而不是节点的度量。相互交换报文的 `BGP` 发言者节点之间互称**对等体（Peer）**，若干相关的对等体可以构成**对等体组（Peer Group）**。

`BGP`路由计算过程大致如下。

- （1）每一个发言者节点只知道所在自治系统中的节点的可达性，将自治系统中收集的路由信息形成初始路由表。
- （2）一个自治系统的发言者节点将自己的路由表发送给相邻的自治系统的发言者节点，与它们共享路由信息。
- （3）当一个发言者节点从相邻节点收到路由表时，就更新自己的路由表，将它自己的路由表中没有的节点加上，并加上自己的自治系统和发送此路由表的自治系统。经过一定时间后，每一个发言者就知道了如何到达其他自治系统中的每一个节点。

路由更新时，`BGP` 只发送更新的路由，大大地减少了 `BGP` 传播路由所占用的带宽，适用于在Internet上传播大量的路由信息。

`BGP`路由通过携带自治系统路径信息彻底解决了路由环路问题。路由器每收到一个报文，就检查并确认它的自治系统是否在到达终点（目的地）的路径上，如果是，就丢弃该报文，这样就可以防止路由环路。

`BGP`支持基于策略的路由，能够对路由实现灵活的过滤和选择。路由器每收到一个报文，就检查路径，如果路径中的一个自治系统与策略相违背，就忽略这条路径和这个终点。它不在路由表中对这条路径进行更新，也不把这个报文发送给它的相邻路由器。

`BGP`根据路径中的自治系统数目、安全性、可靠性等来选择最佳路径。

### BGP会话

两个路由器之间通过一个会话交换路由选择信息。**会话**就是一个连接，它建立在两个 `BGP`路由器之间，目的是为了交换路由选择信息。为产生可靠的环境，`BGP`使用`TCP`服务，`BGP`会话是在`TCP`连接上进行的。但是，为`BGP`所用的`TCP`连接与其他应用程序的有一点不同。如果`TCP` 连接是为 `BGP` 产生的，则能持续很长的时间，直到发生了某些异常情况为止。因此，`BGP`会话可以说是一种半永久的连接。

`BGP`包括`EBGP`（**外部BGP**）会话和`IBGP`（**内部BGP**）会话两种类型，前者用于属于两个不同的自治系统的发言者节点之间交换信息，后者是用于在一个自治系统的发言者节点之间的交换路由选择信息。

## 路径属性

`BGP` 路径属性是一组参数，用于对特定的路由进行进一步的描述，使得 `BGP` 能够对路由进行过滤和选择。路径用自治系统列表来表示，但实际上是用属性列表来表示的。每一个属性给出关于路径的一些信息。当使用策略时，属性列表可帮助接收信息的路由器做出更好的决定。

### 路径属性的分类

路径属性可分为两大类：**公认（Well-known）属性**和**可选（Optional）属性**。公认属性是每一个`BGP`路由器必须知道的。可选属性则不是每一个路由器都必须知道的。

公认属性本身又可划分为两类——强制的（`mandatory`）和自选的（`discretionary`）；而可选属性还可划分为两类——传递的（`transitive`）和非传递的（`non-transitive`）。这样所有的路径属性都可以归到以下4种类型。

- **公认强制属性**：这是在路由的描述中必须出现的属性。所有`BGP`路由器都必须能够识别这种属性，且必须存在于更新报文中。如果缺少这种属性，路由信息就会出错。
- **公认自选属性**：这是每一个路由器必须知道的属性。所有`BGP`路由器都可以识别，但不一定要包括在每一个更新报文中，可以根据具体情况来选择。
- **可选传递属性**：在自治系统之间具有可传递性的属性。`BGP` 路由器可以不支持此属性，但它仍然会接收带有此属性的路由，并通告给其他对等体。
- **可选非传递属性**：如果`BGP`路由器不支持此属性，该属性被忽略，且不会通告给其他对等体。

### 几种主要的路由属性

下面介绍几个公认强制属性。

- **源（ORIGIN）**：用于定义路由选择信息的来源（RIP、OSPF 等）。它包括 3 种类型：IGP表示路由产生于本自治系统内，优先级最高；EGP说明路由来自于外部网关协议，优先级次之；INCOMPLETE优先级最低，并不是说明路由不可达，而是表示路由的来源无法确定。
- **自治系统路径（AS_PATH）**：用于定义自治系统列表（从本地到目的地址所要经过的所有AS号），离本地AS最近的相邻AS号排在前面，其他AS号按顺序依次排列。通常情况下，`BGP`不会接受AS_PATH中已包含本地AS号的路由，从而避免了形成路由环路的可能。
- **下一跳（NEXT_HOP）**：用于定义应当作为到达更新报文中所列目的地的下一跳的路由器的IP地址。

## BGP报文格式

`BGP`有5种报文格式：打开（Open）、更新（Update）、通知（Notification）、保持活动（Keepalive）和路由器更新（Route-refresh）。`BGP`报文封装成TCP数据段，并使用公认端口179传输，这样可提高协议的可靠性。当打开TCP连接时，更新报文、保持活动报文和通知报文就一直交换着，直到发送出关闭通知报文为止。

`BGP`报文只有全部收到后才进行处理。报文的最大长度是4096字节，最小的报文长度是19字节，仅包括`BGP`首部，不包含任何数据。在AS1和AS2之间建立的会话是`EBGP`会话。这两个发言人路由器交换的信息是它知道的关于 Internet 中的一些网络的信息。但是，这两个路由器需要从这个自治系统中的其他路由器收集信息。这就要使用`IBGP`会话。

### 报文首部

所有类型的`BGP`报文具有相同的报文首部，其格式如下所示。

![image](./assets/bgp-2.png)

部长度固定为19字节。标记（Marker）字段占16字节，用于标明`BGP`报文边界，所有位均置1。长度字段占2字节，指明`BGP`报文总长度（包括报文首部在内），以字节为单位。类型字段占1字节，指示`BGP`报文的类型。目前取值从1到5，分别表示打开、更新、通知、保持活动和路由刷新。

### 打开（Open）报文

打开报文是TCP连接建立后发送的第一个报文，用于建立`BGP`路由器之间的邻站关系。`BGP`路由器打开与相邻的`BGP`路由器的TCP连接，并发送打开报文。如果对方同意，则响应一个保持活动报文，表示在这两个路由器之间已经建立了关系。打开报文格式如下图所示。

![image](./assets/bgp-3.png)

除了固定的`BGP`报文首部（类型值为1）外，其他主要字段说呀如下。

- **版本（Version）**：`BGP`的版本号。对于BGP-4 来说，其值为4。
- **本自治系统（My Autonomous System）**：指明本路由器所属的自治系统的编号。通过比较两端的AS号可以确定是`EBGP`连接还是`IBGP`连接。
- **保持时间（Hold time）**：指明本路由器在收到相邻路由器的保持活动或更新报文前保持连接的秒数。在建立对等体关系时两端要协商保持时间，并保持一致。如果在这个时间内未收到对方发来的保持活动或更新报文，则认为BGP连接中断。
- **BGP标识符**：以IP地址的形式表示，用来识别`BGP`路由器。
- **选项参数长度（Opt Parm Len）**：表示选项参数的长度。如果为0 则表示没有可选参数。
- **选项参数（Optional Parameters）**：是一个变长字段，每个选项由参数类型（Parameter Type）、参数长度（Parameter Length）和参数值（Parameter Value）3个子字段构成。RFC 3392定义了能力（Capabilities）选项参数。

### 更新（Update）报文

更新报文用于在`BGP`对等体之间交换路由信息。它既可以发布可达路由信息，也可以撤销不可达路由信息。其报文格式如下图所示。

![image](./assets/bgp-4.png)

主要字段说明如下。

- **撤销路由长度（Withdrawn Routes Length）**：指示撤销路由字段的长度，以字节为单位。如果为0，则说明没有撤销路由字段。
- **撤销路由（Withdrawn Routes）**：这是一个可变长字段，包括一个要撤销的路由器的IP地址前缀列表，它由前缀长度（位）和前缀构成。

:::tip 提示
每个IP地址前缀由长度和前缀两个子字段组成。长度子字段指示IP地址网络前缀的长度，单位是位；前缀子字段定义该网络地址的共同部分。例如，网络是192.18.7.0/24，则长度是24，而前缀是192.18.70。BGP-4支持无分类编址和`CIDR`。
:::

- **路径属性总长度（Total Path Attribute Length）**：指示路径属性字段的长度，以字节为单位。如果为0则说明没有路径属性字段。
- **路径属性（Path Atributes）**：定义下一字段（NLRI）给出的可达网络的路径属性。每个路径属性由一个TLV（Type-Length-Value）三元组构成。`BGP`正是根据这些属性值来避免环路、进行选路、扩展协议等。
- **网络层可达信息（Network Layer Reachability Information，NLRI）**：给出可达路由的IP地址前缀列表。它为变长字段，是本报文要通告的可达网络，由前缀长度（位）和前缀构成。

一条更新报文可以通告一类具有相同路径属性的可达路由，这些路由放在网络层可达信息字段中，路径属性字段携带了这些路由的属性，`BGP`根据这些属性进行路由的选择；同时更新报文还可以携带多条不可达路由，被撤销的路由放在撤销路由字段中。

### 通知（Notification）报文

当BGP检测到错误状态时，或者路由器要关闭与另一个路由的连接时，发送的报文就向对等体发出通告，之后BGP连接会立即中断。其报文格式如下图所示。

![image](./assets/bgp-5.png)

主要字段的解释如下：

- **错误代码（Error code）**：指定错误类型。
- **错误子代码（Error subcode）**：指示错误类型的详细信息。
- **数据（Data）**：提示用于辅助发现错误的原因，它的内容依赖于具体的错误码和子码，记录的是出错部分的数据，长度不固定。

### 保持活动（Keepalive）报文

BGP会周期性地向对等体发出保持活动报文，用来保持连接的有效性。其报文格式中只包含报文首部，没有附加其他任何字段。运行BGP协议的各路由器定期地互相交换保持活动报文，用来告诉对方自己是正在运行的。

### 路由刷新（Route-refresh）报文

路由刷新报文用来要求对等体重新发送指定地址族的路由信息。其报文格式如下图所示。

![image](./assets/bgp-6.png)
