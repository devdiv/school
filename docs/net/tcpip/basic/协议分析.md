# 协议分析

协议分析（Protocol Analysis）又称网络分析（Network Analysis），是接入网络通信系统捕获网络中传输的数据，收集网络统计信息，将**数据包解码为可读形式的过程**。本质上，协议分析器窃听网络通信。由于这些工具能够揭示许多不同类型的、有潜在价值的信息，甚至破坏信息，很多机构制定规则禁止对生产网络无监督地使用协议分析器。许多协议分析器也能够发送数据包，可用于测试网络或设备，它们能够使用加载到桌面或便携计算机上的软件或硬件/软件产品来进行协议分析。

**协议分析**实际上是一种包嗅探技术，可查询网络中的每个数据包，能够确定某一应用或`IP`地址产生的流量，便于监测网络数据传输，排除网络故障。它最大的优势是可以区分和分析网络层以上的信息。

## 协议分析原理

在以太网中，所有通信都是以**广播**方式工作的，同一个网段的所有网络接口都可访问传输介质上传输的所有数据，也就是说，所有的物理信号都要经过网络中的任何一个节点。而每一个网络接口都有一个唯一的硬件地址（MAC地址）。在正常的情况下，一个网络接口只能响应两种数据帧：**与自己硬件地址相匹配的数据帧**和**发向所有节点的广播数据帧**。

在网络中，数据的收发是由**网卡**来完成的，网卡有以下4种接收模式。

- **广播**：能够接收发送给自己的数据帧和网络中的广播信息。
- **多播**：只能够接收多播数据。
- **直接**：只能够接收发送给自己的数据帧。
- **混杂**（Promiscuous Mode）：能够接收一切通过它的数据帧，而不管该数据是否是传给它的。

**默认情况下，网卡处于广播模式，但是，将其设置为混杂模式时，就可以接收所有通过网络设备的数据了，此时采用协议分析技术就可捕获所有经过网卡的数据包。** 协议分析工具所使用的网卡和驱动程序只有支持混杂模式时，才能捕获到以太网冲突分片（Ethernet Collision Fragment）、超长数据包、超短数据包以及在非法边界上结束的数据包。

协议分析工具提供包过滤器（Filter）用于确定想要捕获的数据包的类型，对于捕获的数据进行解码，以可读方式给出数据包的字段和值。

## 协议分析分类

现有协议分析按类型可以分为标准协议分析、私有协议分析和未知协议分析。标准协议为国际或国家标准化组织采纳或批准的；私有协议也称非标准协议，本质上是未经国际或国家标准化组织采纳或批准的，厂商内部发展和采用的标准，除非授权，其他厂商一般无权使用该协议；未知协议由未公开协议文档的未知应用层协议生成，不能使用传统的协议识别工具识别分析。

## 协议分析方法

### 基于规则匹配的网络协议分析与数据处理方法

大致包含：

- 1)捕获网络中的数据包；
- 2)将所捕获的数据包的指纹与目的指纹相比较；
- 3)判断通过指纹比对后的数据包是否为完整数据包；
- 4)对完整数据包进行数据挖掘，生成新的关联规则；
- 5)根据从规则库解析出来的协议，利用协议的特征对数据包进行协议分析；
- 6)管理服务器根据信息日志，对警告信号进行实时响应；同时，判断是否将新生成的关联规则保存到规则库中。

### 基于基函数的网络协议分析方法

大致包含：

- 1）建立基函数库和已知结构协议的基函数模式组合方式库；
- 2）当接收到目标网络发过来的数据，利用该数据和已有的基函数模式组合方式表征该目标网络对应的目标协议的结构；
- 3）根据目标协议的结构进行判断：如果该数据为已知结构的协议数据，采用分层的方法对该目标协议进行分析；如果该数据为未知结构的协议数据，利用已有基函数或新的基函数生成该目标协议对应的基函数模式组合方式。

该方式可以解决协议快速识别、精确分析处理的问题。

### 基于反汇编的私有协议的分析方法

大致包含：

**步骤一**：先将采用私有协议进行通信的客户端软件进行脱壳处理，得到脱壳后的原始程序；再对原始程序进行反汇编，得到该原始程序的汇编代码；然后对其汇编代码中的关键函数进行动态调试，从而得到该私有协议的报文类型的字段长度和构造特征；

其中关键函数包括：

- 1.报文数据包的构造函数；
- 2.发送和接收报文数据包的函数；
- 3.加密和解密函数；

**步骤二**：抓取该私有协议的网络流数据，并按协议交互的不同阶段进行报文数据包分类，然后分别解析出每类报文数据包的字段结构；

**步骤三**：对交互过程中的协议特征进行提取和归纳；其中：协议特征包括交互过程信息和报文数据包的字段结构特征；

**步骤四**：利用步骤三中所得到的协议特征，设置协议识别的匹配表达式，对网络中获取到的流量进行识别。

### 基于数据清洗和协议字段特征提取方法

![image](./assets/协议分析-7.png)

大致包含：

- 步骤1：在网络的汇聚点抓取网络数据包；
- 步骤2：数据标记：将抓取到的所述网络数据包按照抓取的时间顺序进行标记；
- 步骤3：通过数据分类汇聚、获取公共数据地址、获取服务端地址、数据再分类、排除已知协议，得到清洗后的未知协议数据，具体按照下述步骤处理：
- 步骤3.1数据分类汇聚：将步骤2得到的经过标记的网络数据包，分别按源地址数据和目的地址数据进行双向配对归类，相同源地址的数据汇聚为一类，以下简称i类数据；相同目的地址的数据汇聚为一类，以下简称ii类数据，并将所述i类数据和所述ii类数据分别按时序进行排序；
- 步骤3.2获取公共数据地址：计算经过时序排序的所述i类数据中相同的源地址的数目，取其中数目大于预设源地址数目的数据记为i类公共数据；计算经过时序排序的所述ii类数据中相同的目的地址的数目，取其中数目大于预设目的地址数目的数据记为ii类公共数据；并丢弃不在两类公共数据中的数据；
- 步骤3.3获取服务端地址：比较所述i类公共数据的地址和所述ii类公共数据的地址，如果相同，将该地址标记为服务端地址；否则丢弃；
- 步骤3.4数据再分类：将从步骤3.3得到的具有相同服务端地址标记的数据，重新按源地址数据和服务端地址数据进行双向配对，归为同类；并按时序进行排序，得到数据包；
- 步骤3.5去掉已知协议：利用已知协议特征库匹配步骤3.4得到的数据包，丢掉其中的已知协议的数据包，得到清洗后的未知协议数据包；
- 步骤4：通过计算n-bit源/服务端数据包的均值和方差分布、计算同类数据中不同n-bit源/服务端数据包的均值和方差分布的相似性、计算相似字段特征的稳定性，提取未知协议字段特征，得到未知协议字段特征，具体步骤如下：
- 步骤4.1计算n-bit源/服务端数据包的均值和方差分布：将从步骤3.5得到的清洗后的未知协议数据包，按同类的源地址和服务端地址数据分别对齐，从对齐后的首部开始划分顺序区域，以bit为单位，逐步增加区域内bit数量n，计算各顺序区域数据的均值和方差，以下称为n-bit源/服务端数据包的均值和方差分布；
- 步骤4.2计算并比较步骤4.1得到的同类数据中不同n-bit源/服务端数据包的均值和方差分布的相似性，选取相似性较大的作为n-bit相似字段特征；
- 步骤4.3计算并比较步骤4.2得到的n-bit相似字段特征的稳定性，选取稳定性较大的作为未知协议字段特征；
- 步骤5：确认未知协议字段特征，并建立协议字段特征识别的匹配表达式，存入未知协议字段特征库。

> 据有关统计，在每周的统计数据流量监测中超过四成流量属于未知应用协议，这些流量给网络管理、流量监控以及入侵检测等带来了巨大的挑战，而随着新技术的发展，已有的方法对于未知协议的识别效果越来越差。有效的未知协议分析方法，对网络管理、流量监控、入侵检测以及维护网络安全都有重要意义。

## 协议分析应用场合

协议分析工具能够检查经过网卡的所有网络数据包，并进行解码和分析。主要应用场合如下。

- 诊断网络通信故障。将它安装在网络上并配置为捕获存在问题的通信序列，通过读取分析所传输的数据包来识别出通信过程中存在的缺陷和错误。
- 测试网络。可以通过侦听不同寻常的通信或向网络中发送数据包来对网络进行测试。
- 评估网络性能和分析流量趋势。
- 用于教学和实验。考察和验证TCP/IP网络中不同数据包的结构和通信序列。

## 协议分析工具的部署

协议分析工具只能访问和检查实际流经监测计算机所在网卡的数据包，理解这一点非常重要。在传统共享网（以集线器连接）中，可直接获取网络中的所有数据。但是，在交换网络中，只有特定的流量（如广播数据）能够发送到每个计算机的网卡，可直接看到本机收发的流量，通常不能直接看到网络中其他计算机的全部流量。这就需要使用支持监测端口或端口镜像配置的交换机。也可采用其他变通手段，如串接网络分路器（`Tap`）或集线器（`Hub`）。实际应用中根据不同网络环境和监测要求来选择部署方式。

(1)传统共享式网络

使用集线器（Hub）作为网络中心交换设备的网络，如下图所示，可将协议分析工具安装在局域网中任意一台计算机上，可以获取整个网络中所有的通信数据。

![image](./assets/协议分析-1.png)

(2)具备镜像功能的交换式网络

交换式网络会将整个网络分隔成很多小的网域，多数3层或3层以上交换机，以及部分二层交换机具备镜像功能（Cisco将这种功能称为“SPAN”），对于采用这种交换机的网络，如下图所示，可在交换机上配置好端口镜像，再将协议分析工具安装在连接镜像端口的主机上，可以捕获整个网络中所有的通信数据。

![image](./assets/协议分析-2.png)

(3)不具备镜像功能的交换式网络

普通交换机可能并不具备镜像功能，这样就不能通过端口镜像实现网络的监测分析。这就需要采取变通手段，可在交换机与路由器（或防火墙）之间串接一个分路器或集线器，分别如下图所示，可以获取整个网络中所有的通信数据。

![image](./assets/协议分析-3.png)
![image](./assets/协议分析-4.png)

**分路器**是专用设备，可将连接的链路的全部数据信息复制到监测工具，具有较高的性能，可用于大流量网络，获取100％的数据包，而且方便监测工具接入和移动。

**集线器**成本很低，仅适用于流量不大的网络，而且现在相关的产品也非常少。

(4)部署代理服务器的网络
对于通过代理服务器共享上网的情况，直接将包嗅探工具安装在代理服务器上即可，如下图所示，这样可同时对代理服务器的内部网卡和外部网卡进行数据捕获。

![image](./assets/协议分析-5.png)

(5)监测某个特定网段
对于规模较大的网络，常常并不需要监测整个网络，只需要对某些可能出现异常的部门或网段进行监测分析，这时可将网络分路器（也可用集线器替代）串接到要监测的网段，以实现特定网段的数据采集，如下图所示。

![image](./assets/协议分析-6.png)

